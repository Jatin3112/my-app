# Sprint 1.2 — Razorpay Integration Design

## Overview

Integrate Razorpay Subscriptions API so Indian users can subscribe to Solo/Team/Agency plans using UPI, cards, or netbanking. Includes upgrade/downgrade with Razorpay-managed proration and cancellation that stays active until period end.

## User Stories

- US-1.4: As an Indian user, I can subscribe to a plan using UPI/cards via Razorpay
- US-1.5: As a subscriber, I can upgrade/downgrade my plan
- US-1.6: As a subscriber, I can cancel my subscription and it stays active until period end

## Architecture

### Payment Flow

```
User (trial/expired) → clicks "Upgrade" on billing page
  → POST /api/payments/razorpay/create-subscription
      (validates session, creates Razorpay subscription)
  → Returns subscription_id to client
  → Client opens Razorpay checkout modal (loads checkout.js CDN)
  → User pays via UPI/cards/netbanking
  → Razorpay sends webhook to /api/payments/razorpay/webhook
  → Webhook handler verifies signature, updates DB:
      subscription.activated → status = "active", set period dates
      subscription.charged   → insert payment_history, update period dates
      subscription.cancelled → status = "cancelled"
      payment.captured       → insert payment_history record
```

### Schema Change

Add `razorpay_plan_id` text column to `plans` table. This stores the Razorpay-side plan ID created via their API.

### New Files

| File | Purpose |
|------|---------|
| `lib/payments/razorpay.ts` | Razorpay client init, createSubscription, cancelSubscription, updateSubscription, verifyWebhookSignature, syncPlansToRazorpay |
| `app/api/payments/razorpay/create-subscription/route.ts` | POST — auth-protected, creates Razorpay subscription for a plan |
| `app/api/payments/razorpay/webhook/route.ts` | POST — signature-verified, handles Razorpay events |
| `components/billing/razorpay-checkout.tsx` | Client component — loads checkout.js, opens modal on click |
| `components/billing/pricing-cards.tsx` | Plan cards with Upgrade/Downgrade/Current badges |

### Modified Files

| File | Change |
|------|--------|
| `lib/db/schema.ts` | Add `razorpay_plan_id` to plans table |
| `lib/db/seed-plans.ts` | Auto-create Razorpay plans via API, store IDs |
| `app/billing/page.tsx` | Wire up PricingCards + RazorpayCheckout, show real payment history |
| `lib/api/subscriptions.ts` | Add helpers for subscription status transitions |

### Key Decisions

- **Plan sync**: Auto-create Razorpay plans via API in seed script, store `razorpay_plan_id` in DB
- **Proration**: Razorpay-managed — use their subscription update API for upgrades/downgrades
- **Cancellation**: Call Razorpay cancel API, set `cancel_at_period_end = true`, subscription stays active until period end
- **Security**: Webhook signature verification with HMAC-SHA256, create-subscription route validates NextAuth session
- **Client-side**: Only `NEXT_PUBLIC_RAZORPAY_KEY_ID` exposed, all secrets server-side only

### Environment Variables

```
RAZORPAY_KEY_ID=rzp_test_...
RAZORPAY_KEY_SECRET=...
RAZORPAY_WEBHOOK_SECRET=...
NEXT_PUBLIC_RAZORPAY_KEY_ID=rzp_test_...
```

### Webhook Security

Razorpay signs webhooks with HMAC-SHA256 using the webhook secret. The handler must:
1. Read raw body (not parsed JSON)
2. Compute HMAC-SHA256(raw_body, webhook_secret)
3. Compare with `x-razorpay-signature` header
4. Reject on mismatch with 400 status

### Testing Strategy

- Unit tests for `lib/payments/razorpay.ts` (mock Razorpay SDK)
- Unit tests for webhook handler (signature verification, event processing)
- Component tests for RazorpayCheckout and PricingCards (render states, button interactions)
- Manual E2E test: trial → checkout → payment → active subscription → renewal
