# Sprint 1.3 — Stripe Integration + Email System

**Date:** 2026-02-20
**Status:** Approved
**Sprint:** 1.3 (Week 3-4 of Phase 1: Revenue Foundation)

## Overview

Add Stripe payment gateway for international (USD) users alongside existing Razorpay (INR), and build an email system for workspace invitations, trial expiry warnings, and payment receipts.

## Decisions

- **Stripe Checkout** (redirect-based) — simpler than Elements, handles PCI compliance, matches task list
- **Both gateways** — Razorpay for India (UPI, cards), Stripe for international (USD)
- **Currency detection** — auto-detect via browser locale, manual toggle available
- **Email** — Nodemailer + Gmail SMTP, graceful no-op if env vars missing
- **Cron** — API route + external cron service (cron-job.org or similar), secured with CRON_SECRET

## Architecture

### Stripe Payment Flow

```
User clicks "Subscribe" (USD)
  → POST /api/payments/stripe/create-checkout
  → Stripe Checkout Session created
  → User redirected to stripe.com
  → Payment completed
  → Stripe webhook fires
  → POST /api/payments/stripe/webhook
  → Subscription activated in DB
  → User redirected to /billing/success
```

### Email System

```
lib/email/
  index.ts              — sendEmail() utility (Nodemailer + Gmail SMTP)
  templates/
    invite.ts           — workspace invitation email
    trial-expiry.ts     — trial warning (parameterized days)
    welcome.ts          — post-registration welcome
    payment-receipt.ts  — payment confirmation
```

### Cron Job

```
GET /api/cron/trial-expiry
  → Secured with CRON_SECRET header
  → Queries subscriptions with status="trialing"
  → Sends warnings at day 4, 2, 1, 0 remaining
  → Hit daily by external cron service
```

## Schema Changes

- `plans` table: add `stripe_price_id: text` (alongside `razorpay_plan_id`)
- `workspaces` table: add `stripe_customer_id: text`

## New Files

- `lib/payments/stripe.ts` — Stripe client, helpers
- `app/api/payments/stripe/create-checkout/route.ts`
- `app/api/payments/stripe/webhook/route.ts`
- `app/billing/success/page.tsx`
- `app/billing/cancel/page.tsx`
- `components/billing/stripe-checkout.tsx`
- `lib/email/index.ts`
- `lib/email/templates/invite.ts`
- `lib/email/templates/trial-expiry.ts`
- `lib/email/templates/welcome.ts`
- `lib/email/templates/payment-receipt.ts`
- `app/api/cron/trial-expiry/route.ts`

## Modified Files

- `lib/db/schema.ts` — add stripe_price_id, stripe_customer_id
- `lib/db/seed-plans.ts` — create Stripe products/prices during seed
- `lib/api/invitations.ts` — wire sendEmail after creating invitation
- `components/billing/pricing-cards.tsx` — show Razorpay/Stripe based on currency
- `app/billing/page.tsx` — add currency auto-detection
- `package.json` — add stripe, @stripe/stripe-js, nodemailer deps

## Testing

- Unit tests for `lib/payments/stripe.ts` (mock Stripe SDK)
- Unit tests for webhook handler (signature verification, event handling)
- Unit tests for `lib/email/index.ts` (mock Nodemailer)
- Unit tests for email templates (render with test data)
- Component tests for StripeCheckout, updated PricingCards
- Full flow test (mocked): checkout → webhook → subscription active
