# Sprint 6.1 — Infrastructure + Monitoring Design

## Rate Limiting

**Approach:** In-memory sliding window using `Map<string, number[]>`. No Redis dependency — suitable for single-instance Vercel deployments.

**File:** `lib/api/rate-limit.ts` — `rateLimit(key, maxRequests, windowMs)` returns `{ success, remaining, resetAt }`.

**Limits:**
- Login: 5 requests/minute per IP
- Register: 3 requests/minute per IP
- General API: 60 requests/minute per user

**Response:** 429 Too Many Requests with `Retry-After` header.

## CSRF Protection

NextAuth handles CSRF for its own endpoints. For custom API routes, add origin-check middleware that validates `Origin`/`Referer` headers against allowed origins. No token-based CSRF needed — app uses `SameSite=Lax` cookies.

**File:** `lib/api/csrf.ts` — `validateOrigin(request)` checks headers against `NEXTAUTH_URL`.

## Admin Dashboard

**Protection:** Email whitelist via `ADMIN_EMAILS` env var (comma-separated). Check in layout before rendering.

**Files:**
- `app/(admin)/admin/layout.tsx` — auth + admin check
- `app/(admin)/admin/page.tsx` — stats cards + workspace table
- `lib/api/admin.ts` — `getAdminStats()`, `getWorkspaceList()`, `updateWorkspaceSubscription()`

**Stats:** Total users, total workspaces, active trials, MRR (sum of active plan prices).

**Workspace list:** Name, owner, plan, member count, status (trialing/active/expired), created date. Sortable table.

**Actions:** Extend trial (set new trial_end), change plan (update plan_id on subscription).

## Error Tracking (Sentry)

Install `@sentry/nextjs`. Create config files that initialize from `SENTRY_DSN` env var. No-ops when env var is missing.

**Files:**
- `sentry.client.config.ts`
- `sentry.server.config.ts`
- `next.config.ts` wrapped with `withSentryConfig`

## Analytics (PostHog)

Create analytics wrapper that conditionally initializes PostHog when `NEXT_PUBLIC_POSTHOG_KEY` is set. No-ops when missing (same pattern as Redis cache).

**File:** `lib/analytics.ts` — `trackEvent(name, properties)`, `identifyUser(userId, traits)`.

## Vercel Deployment

Create `vercel.json` with build settings and cron job configuration for `/api/cron/trial-expiry`. Custom domain and SSL are manual Vercel dashboard tasks.

## Uptime Monitoring

Document BetterStack/UptimeRobot setup instructions. No code needed — external service configuration.
