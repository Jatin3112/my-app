# Sprint 1.1 — Database & Plan Infrastructure Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add subscription plans, trial system, plan enforcement, and billing UI so the app can gate features behind paid tiers.

**Architecture:** Three new DB tables (`plans`, `subscriptions`, `payment_history`) follow existing Drizzle patterns (UUID PKs, timestamps, relations). A `plan-enforcement.ts` module wraps existing server actions to check limits before mutations. Trial auto-creates on workspace creation. Billing UI components slot into existing sidebar/topbar layout.

**Tech Stack:** Drizzle ORM (schema + migrations), Next.js server actions, React client components (shadcn/ui), existing RBAC permission system.

---

## Task 1: Add `plans` Table to Schema

**Files:**
- Modify: `lib/db/schema.ts` (append after `notificationPreferences` table)

**Step 1: Add the plans table definition**

Add this to the end of `lib/db/schema.ts`, before the relations section:

```typescript
export const plans = pgTable("plans", {
  id: uuid("id").defaultRandom().primaryKey(),
  name: text("name").notNull(),
  slug: text("slug").unique().notNull(),
  price_inr: integer("price_inr").notNull(),
  price_usd: integer("price_usd").notNull(),
  max_users: integer("max_users").notNull(),
  max_projects: integer("max_projects").notNull(),
  max_workspaces: integer("max_workspaces").notNull(),
  features: json("features").$type<string[]>().default([]),
  is_active: boolean("is_active").default(true).notNull(),
  created_at: timestamp("created_at").defaultNow().notNull(),
  updated_at: timestamp("updated_at").defaultNow().notNull(),
});

export type Plan = typeof plans.$inferSelect;
export type NewPlan = typeof plans.$inferInsert;
```

**Step 2: Add plans relations**

```typescript
export const plansRelations = relations(plans, ({ many }) => ({
  subscriptions: many(subscriptions),
}));
```

**Step 3: Verify no TypeScript errors**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors related to `plans` table (subscriptions table not yet defined — that's OK, we'll add it next).

---

## Task 2: Add `subscriptions` Table to Schema

**Files:**
- Modify: `lib/db/schema.ts` (append after `plans` table)

**Step 1: Add the subscriptions table definition**

```typescript
export const subscriptions = pgTable("subscriptions", {
  id: uuid("id").defaultRandom().primaryKey(),
  workspace_id: uuid("workspace_id").references(() => workspaces.id, { onDelete: "cascade" }).notNull(),
  plan_id: uuid("plan_id").references(() => plans.id).notNull(),
  status: text("status").notNull().default("trialing"),
  // status values: "trialing" | "active" | "past_due" | "cancelled" | "expired"
  trial_start: timestamp("trial_start"),
  trial_end: timestamp("trial_end"),
  current_period_start: timestamp("current_period_start"),
  current_period_end: timestamp("current_period_end"),
  payment_provider: text("payment_provider"),
  // "razorpay" | "stripe" | null (for trial)
  provider_subscription_id: text("provider_subscription_id"),
  cancel_at_period_end: boolean("cancel_at_period_end").default(false).notNull(),
  created_at: timestamp("created_at").defaultNow().notNull(),
  updated_at: timestamp("updated_at").defaultNow().notNull(),
}, (table) => ({
  workspaceIdx: index("subscriptions_workspace_id_idx").on(table.workspace_id),
}));

export type Subscription = typeof subscriptions.$inferSelect;
export type NewSubscription = typeof subscriptions.$inferInsert;
```

**Step 2: Add subscriptions relations**

```typescript
export const subscriptionsRelations = relations(subscriptions, ({ one }) => ({
  workspace: one(workspaces, {
    fields: [subscriptions.workspace_id],
    references: [workspaces.id],
  }),
  plan: one(plans, {
    fields: [subscriptions.plan_id],
    references: [plans.id],
  }),
}));
```

**Step 3: Update workspaces relations** to include subscriptions

Find the existing `workspacesRelations` and add `subscriptions: many(subscriptions)` to it.

---

## Task 3: Add `payment_history` Table to Schema

**Files:**
- Modify: `lib/db/schema.ts` (append after `subscriptions` table)

**Step 1: Add the payment_history table definition**

```typescript
export const paymentHistory = pgTable("payment_history", {
  id: uuid("id").defaultRandom().primaryKey(),
  workspace_id: uuid("workspace_id").references(() => workspaces.id, { onDelete: "cascade" }).notNull(),
  subscription_id: uuid("subscription_id").references(() => subscriptions.id, { onDelete: "set null" }),
  amount: integer("amount").notNull(),
  currency: text("currency").notNull(),
  // "INR" | "USD"
  provider: text("provider").notNull(),
  // "razorpay" | "stripe"
  provider_payment_id: text("provider_payment_id"),
  status: text("status").notNull().default("pending"),
  // "pending" | "captured" | "failed" | "refunded"
  description: text("description"),
  created_at: timestamp("created_at").defaultNow().notNull(),
}, (table) => ({
  workspaceIdx: index("payment_history_workspace_id_idx").on(table.workspace_id),
}));

export type PaymentRecord = typeof paymentHistory.$inferSelect;
export type NewPaymentRecord = typeof paymentHistory.$inferInsert;
```

**Step 2: Add payment_history relations**

```typescript
export const paymentHistoryRelations = relations(paymentHistory, ({ one }) => ({
  workspace: one(workspaces, {
    fields: [paymentHistory.workspace_id],
    references: [workspaces.id],
  }),
  subscription: one(subscriptions, {
    fields: [paymentHistory.subscription_id],
    references: [subscriptions.id],
  }),
}));
```

**Step 3: Push all 3 new tables to the database**

Run:
```bash
npm run db:generate
npm run db:push
```
Expected: Migration generated for `plans`, `subscriptions`, `payment_history` tables. Schema pushed successfully.

**Step 4: Verify in Drizzle Studio**

Run: `npm run db:studio`
Expected: Three new tables visible with correct columns and indexes.

**Step 5: Commit**

```bash
git add lib/db/schema.ts drizzle/
git commit -m "feat: add plans, subscriptions, payment_history tables to schema"
```

---

## Task 4: Create Seed Script for Default Plans

**Files:**
- Create: `lib/db/seed-plans.ts`
- Modify: `package.json` (add seed script)

**Step 1: Create the seed file**

Create `lib/db/seed-plans.ts`:

```typescript
import { db } from "./index";
import { plans } from "./schema";

const DEFAULT_PLANS = [
  {
    name: "Solo",
    slug: "solo",
    price_inr: 499,
    price_usd: 9,
    max_users: 1,
    max_projects: 3,
    max_workspaces: 1,
    features: ["voice_capture", "timesheet", "dashboard", "export_csv"],
  },
  {
    name: "Team",
    slug: "team",
    price_inr: 999,
    price_usd: 19,
    max_users: 5,
    max_projects: 10,
    max_workspaces: 3,
    features: ["voice_capture", "timesheet", "dashboard", "export_csv", "export_pdf", "comments", "notifications"],
  },
  {
    name: "Agency",
    slug: "agency",
    price_inr: 1999,
    price_usd: 35,
    max_users: 15,
    max_projects: -1,
    max_workspaces: -1,
    features: ["voice_capture", "timesheet", "dashboard", "export_csv", "export_pdf", "comments", "notifications", "file_attachments", "recurring_tasks", "priority_support"],
  },
];

async function seed() {
  console.log("Seeding plans...");

  for (const plan of DEFAULT_PLANS) {
    const existing = await db.query.plans.findFirst({
      where: (p, { eq }) => eq(p.slug, plan.slug),
    });

    if (existing) {
      console.log(`  Plan "${plan.name}" already exists, skipping.`);
      continue;
    }

    await db.insert(plans).values(plan);
    console.log(`  Created plan: ${plan.name}`);
  }

  console.log("Seeding complete.");
  process.exit(0);
}

seed().catch((err) => {
  console.error("Seed failed:", err);
  process.exit(1);
});
```

**Step 2: Add seed script to package.json**

Add to the `"scripts"` section:
```json
"db:seed": "npx tsx lib/db/seed-plans.ts"
```

**Step 3: Run the seed**

Run: `npm run db:seed`
Expected: Output shows 3 plans created (Solo, Team, Agency).

**Step 4: Verify in Drizzle Studio**

Run: `npm run db:studio`
Expected: `plans` table has 3 rows.

**Step 5: Commit**

```bash
git add lib/db/seed-plans.ts package.json
git commit -m "feat: add seed script for default plans (Solo, Team, Agency)"
```

---

## Task 5: Create `lib/api/subscriptions.ts` — Core Subscription Logic

**Files:**
- Create: `lib/api/subscriptions.ts`

**Step 1: Create the server action file**

Create `lib/api/subscriptions.ts`:

```typescript
"use server";

import { db } from "@/lib/db";
import { subscriptions, plans, workspaceMembers, projects, workspaces } from "@/lib/db/schema";
import { eq, and, count } from "drizzle-orm";
import { cached, cacheDel } from "@/lib/cache";
import type { Plan, Subscription } from "@/lib/db/schema";

// ─── Types ───

export type SubscriptionWithPlan = Subscription & { plan: Plan };

export type PlanLimits = {
  maxUsers: number;
  maxProjects: number;
  maxWorkspaces: number;
  features: string[];
};

export type UsageInfo = {
  currentUsers: number;
  currentProjects: number;
  currentWorkspaces: number;
  limits: PlanLimits;
};

// ─── Queries ───

export async function getSubscription(workspaceId: string): Promise<SubscriptionWithPlan | null> {
  const sub = await db.query.subscriptions.findFirst({
    where: eq(subscriptions.workspace_id, workspaceId),
    with: { plan: true },
    orderBy: (s, { desc }) => [desc(s.created_at)],
  });
  return sub ?? null;
}

export async function getPlanBySlug(slug: string): Promise<Plan | null> {
  const plan = await db.query.plans.findFirst({
    where: eq(plans.slug, slug),
  });
  return plan ?? null;
}

export async function getAllPlans(): Promise<Plan[]> {
  return cached("all-plans", 3600, async () => {
    return db.query.plans.findMany({
      where: eq(plans.is_active, true),
      orderBy: (p, { asc }) => [asc(p.price_inr)],
    });
  });
}

// ─── Trial Management ───

export async function createTrialSubscription(workspaceId: string): Promise<Subscription> {
  // Get the Agency plan (trial gives full features)
  const agencyPlan = await getPlanBySlug("agency");
  if (!agencyPlan) throw new Error("Agency plan not found. Run db:seed first.");

  const now = new Date();
  const trialEnd = new Date(now);
  trialEnd.setDate(trialEnd.getDate() + 14);

  const [sub] = await db
    .insert(subscriptions)
    .values({
      workspace_id: workspaceId,
      plan_id: agencyPlan.id,
      status: "trialing",
      trial_start: now,
      trial_end: trialEnd,
    })
    .returning();

  return sub;
}

export function isTrialExpired(sub: SubscriptionWithPlan): boolean {
  if (sub.status !== "trialing") return false;
  if (!sub.trial_end) return false;
  return new Date() > new Date(sub.trial_end);
}

export function getTrialDaysRemaining(sub: SubscriptionWithPlan): number {
  if (sub.status !== "trialing" || !sub.trial_end) return 0;
  const diff = new Date(sub.trial_end).getTime() - Date.now();
  return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
}

// ─── Plan Limits ───

export function getPlanLimits(plan: Plan): PlanLimits {
  return {
    maxUsers: plan.max_users,
    maxProjects: plan.max_projects,
    maxWorkspaces: plan.max_workspaces,
    features: (plan.features as string[]) ?? [],
  };
}

export async function getUsageInfo(workspaceId: string, userId: string): Promise<UsageInfo> {
  const sub = await getSubscription(workspaceId);

  // Default limits if no subscription (shouldn't happen, but safety)
  const defaultLimits: PlanLimits = {
    maxUsers: 1,
    maxProjects: 3,
    maxWorkspaces: 1,
    features: [],
  };

  if (!sub) {
    return { currentUsers: 0, currentProjects: 0, currentWorkspaces: 0, limits: defaultLimits };
  }

  const limits = getPlanLimits(sub.plan);

  const [userCount, projectCount, workspaceCount] = await Promise.all([
    db.select({ count: count() }).from(workspaceMembers).where(eq(workspaceMembers.workspace_id, workspaceId)),
    db.select({ count: count() }).from(projects).where(eq(projects.workspace_id, workspaceId)),
    db.select({ count: count() })
      .from(workspaceMembers)
      .where(eq(workspaceMembers.user_id, userId)),
  ]);

  return {
    currentUsers: userCount[0].count,
    currentProjects: projectCount[0].count,
    currentWorkspaces: workspaceCount[0].count,
    limits,
  };
}

// ─── Status Helpers ───

export function isSubscriptionActive(sub: SubscriptionWithPlan): boolean {
  if (sub.status === "active") return true;
  if (sub.status === "trialing" && !isTrialExpired(sub)) return true;
  return false;
}

export async function getWorkspaceSubscriptionStatus(workspaceId: string): Promise<{
  isActive: boolean;
  status: string;
  plan: Plan | null;
  trialDaysRemaining: number;
  isTrialing: boolean;
}> {
  const sub = await getSubscription(workspaceId);

  if (!sub) {
    return { isActive: false, status: "none", plan: null, trialDaysRemaining: 0, isTrialing: false };
  }

  const active = isSubscriptionActive(sub);
  const daysLeft = getTrialDaysRemaining(sub);

  // Auto-expire trial if past due
  if (sub.status === "trialing" && isTrialExpired(sub)) {
    await db
      .update(subscriptions)
      .set({ status: "expired", updated_at: new Date() })
      .where(eq(subscriptions.id, sub.id));
    return { isActive: false, status: "expired", plan: sub.plan, trialDaysRemaining: 0, isTrialing: false };
  }

  return {
    isActive: active,
    status: sub.status,
    plan: sub.plan,
    trialDaysRemaining: daysLeft,
    isTrialing: sub.status === "trialing",
  };
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit --pretty 2>&1 | head -20`
Expected: No errors.

**Step 3: Commit**

```bash
git add lib/api/subscriptions.ts
git commit -m "feat: add subscription server actions (trial, limits, status helpers)"
```

---

## Task 6: Auto-Create Trial on Workspace Creation

**Files:**
- Modify: `lib/api/workspaces.ts` (add trial creation after workspace insert)

**Step 1: Import and wire up trial creation**

In `lib/api/workspaces.ts`, add import:
```typescript
import { createTrialSubscription } from "./subscriptions";
```

In `createWorkspace()`, after the `db.insert(workspaceMembers)` call (where owner is added), add:
```typescript
// Auto-create 14-day trial subscription
await createTrialSubscription(workspace.id);
```

Also do the same in `loadHomePageData()` in `lib/api/loaders.ts` — after the auto-create workspace block for first-time users, add trial creation:
```typescript
import { createTrialSubscription } from "./subscriptions";

// Inside the `if (wsData.length === 0)` block, after workspace + member insert:
await createTrialSubscription(newWs.id);
```

**Step 2: Test manually**

- Delete your test workspace or create a new account
- Verify `subscriptions` table gets a row with `status: "trialing"`, `trial_end` = 14 days from now

**Step 3: Commit**

```bash
git add lib/api/workspaces.ts lib/api/loaders.ts
git commit -m "feat: auto-create 14-day trial subscription on workspace creation"
```

---

## Task 7: Create Plan Enforcement Module

**Files:**
- Create: `lib/api/plan-enforcement.ts`

**Step 1: Create the enforcement module**

Create `lib/api/plan-enforcement.ts`:

```typescript
"use server";

import { db } from "@/lib/db";
import { workspaceMembers, projects } from "@/lib/db/schema";
import { eq, count } from "drizzle-orm";
import { getSubscription, isSubscriptionActive, getPlanLimits } from "./subscriptions";

export type EnforcementResult = {
  allowed: boolean;
  reason?: string;
  currentUsage?: number;
  limit?: number;
};

export async function canAddMember(workspaceId: string): Promise<EnforcementResult> {
  const sub = await getSubscription(workspaceId);
  if (!sub) return { allowed: false, reason: "No active subscription" };
  if (!isSubscriptionActive(sub)) return { allowed: false, reason: "Subscription is not active" };

  const limits = getPlanLimits(sub.plan);
  if (limits.maxUsers === -1) return { allowed: true }; // unlimited

  const [result] = await db
    .select({ count: count() })
    .from(workspaceMembers)
    .where(eq(workspaceMembers.workspace_id, workspaceId));

  const current = result.count;
  if (current >= limits.maxUsers) {
    return { allowed: false, reason: `Plan limit reached (${current}/${limits.maxUsers} members)`, currentUsage: current, limit: limits.maxUsers };
  }

  return { allowed: true, currentUsage: current, limit: limits.maxUsers };
}

export async function canAddProject(workspaceId: string): Promise<EnforcementResult> {
  const sub = await getSubscription(workspaceId);
  if (!sub) return { allowed: false, reason: "No active subscription" };
  if (!isSubscriptionActive(sub)) return { allowed: false, reason: "Subscription is not active" };

  const limits = getPlanLimits(sub.plan);
  if (limits.maxProjects === -1) return { allowed: true }; // unlimited

  const [result] = await db
    .select({ count: count() })
    .from(projects)
    .where(eq(projects.workspace_id, workspaceId));

  const current = result.count;
  if (current >= limits.maxProjects) {
    return { allowed: false, reason: `Plan limit reached (${current}/${limits.maxProjects} projects)`, currentUsage: current, limit: limits.maxProjects };
  }

  return { allowed: true, currentUsage: current, limit: limits.maxProjects };
}

export async function canCreateWorkspace(userId: string): Promise<EnforcementResult> {
  // Check across ALL user's workspaces — find the highest plan they own
  const ownedWorkspaces = await db.query.workspaceMembers.findMany({
    where: eq(workspaceMembers.user_id, userId),
  });

  const workspaceCount = ownedWorkspaces.length;

  // For workspace limits, check the subscription of their primary (first) workspace
  // A user can create workspaces up to the limit of their highest plan
  let maxWorkspaces = 1; // default

  for (const membership of ownedWorkspaces) {
    const sub = await getSubscription(membership.workspace_id);
    if (sub && isSubscriptionActive(sub)) {
      const limits = getPlanLimits(sub.plan);
      if (limits.maxWorkspaces === -1) return { allowed: true }; // unlimited
      if (limits.maxWorkspaces > maxWorkspaces) {
        maxWorkspaces = limits.maxWorkspaces;
      }
    }
  }

  if (workspaceCount >= maxWorkspaces) {
    return { allowed: false, reason: `Plan limit reached (${workspaceCount}/${maxWorkspaces} workspaces)`, currentUsage: workspaceCount, limit: maxWorkspaces };
  }

  return { allowed: true, currentUsage: workspaceCount, limit: maxWorkspaces };
}

export async function requireActiveSubscription(workspaceId: string): Promise<void> {
  const sub = await getSubscription(workspaceId);
  if (!sub) throw new Error("No subscription found. Please subscribe to a plan.");
  if (!isSubscriptionActive(sub)) {
    throw new Error("Your subscription has expired. Please upgrade to continue.");
  }
}
```

**Step 2: Commit**

```bash
git add lib/api/plan-enforcement.ts
git commit -m "feat: add plan enforcement module (member, project, workspace limits)"
```

---

## Task 8: Wire Plan Limits into Existing Server Actions

**Files:**
- Modify: `lib/api/projects.ts` (add limit check to `createProject`)
- Modify: `lib/api/invitations.ts` (add limit check to `inviteMember`)
- Modify: `lib/api/workspaces.ts` (add limit check to `createWorkspace`)

**Step 1: Add project limit check**

In `lib/api/projects.ts`, at the top of `createProject()`, after `requirePermission()`:
```typescript
import { canAddProject } from "./plan-enforcement";

// Inside createProject, after requirePermission:
const projectCheck = await canAddProject(workspaceId);
if (!projectCheck.allowed) throw new Error(projectCheck.reason);
```

**Step 2: Add member invite limit check**

In `lib/api/invitations.ts`, at the top of `inviteMember()`, after permission check:
```typescript
import { canAddMember } from "./plan-enforcement";

// Inside inviteMember, after requirePermission:
const memberCheck = await canAddMember(workspaceId);
if (!memberCheck.allowed) throw new Error(memberCheck.reason);
```

**Step 3: Add workspace creation limit check**

In `lib/api/workspaces.ts`, at the top of `createWorkspace()`:
```typescript
import { canCreateWorkspace } from "./plan-enforcement";

// Inside createWorkspace, before the insert:
const wsCheck = await canCreateWorkspace(userId);
if (!wsCheck.allowed) throw new Error(wsCheck.reason);
```

**Step 4: Verify the app still works**

Run: `npm run build`
Expected: Build succeeds with no errors.

**Step 5: Commit**

```bash
git add lib/api/projects.ts lib/api/invitations.ts lib/api/workspaces.ts
git commit -m "feat: enforce plan limits on project create, member invite, workspace create"
```

---

## Task 9: Create Plan Badge Component (Sidebar)

**Files:**
- Create: `components/billing/plan-badge.tsx`
- Modify: `components/layout/sidebar.tsx` (add PlanBadge)

**Step 1: Create the component**

Create `components/billing/plan-badge.tsx`:

```tsx
"use client";

import { useEffect, useState } from "react";
import { useWorkspace } from "@/hooks/use-workspace";
import { getWorkspaceSubscriptionStatus } from "@/lib/api/subscriptions";
import { Badge } from "@/components/ui/badge";
import { Crown, Clock, AlertTriangle } from "lucide-react";
import Link from "next/link";

export function PlanBadge() {
  const { currentWorkspace } = useWorkspace();
  const [status, setStatus] = useState<{
    isActive: boolean;
    status: string;
    planName: string;
    trialDaysRemaining: number;
    isTrialing: boolean;
  } | null>(null);

  useEffect(() => {
    if (!currentWorkspace?.id) return;
    getWorkspaceSubscriptionStatus(currentWorkspace.id).then((s) => {
      setStatus({
        ...s,
        planName: s.plan?.name ?? "No Plan",
      });
    });
  }, [currentWorkspace?.id]);

  if (!status) return null;

  if (status.isTrialing) {
    const urgent = status.trialDaysRemaining <= 3;
    return (
      <Link href="/billing" className="block px-3 py-2">
        <div className={`flex items-center gap-2 rounded-lg border px-3 py-2 text-xs ${urgent ? "border-red-500/50 bg-red-500/10 text-red-600 dark:text-red-400" : "border-yellow-500/50 bg-yellow-500/10 text-yellow-700 dark:text-yellow-400"}`}>
          <Clock className="h-3.5 w-3.5 shrink-0" />
          <div className="min-w-0">
            <div className="font-medium">Trial</div>
            <div className="truncate">{status.trialDaysRemaining}d remaining</div>
          </div>
        </div>
      </Link>
    );
  }

  if (!status.isActive) {
    return (
      <Link href="/billing" className="block px-3 py-2">
        <div className="flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-xs text-red-600 dark:text-red-400">
          <AlertTriangle className="h-3.5 w-3.5 shrink-0" />
          <div className="min-w-0">
            <div className="font-medium">Expired</div>
            <div className="truncate">Upgrade now</div>
          </div>
        </div>
      </Link>
    );
  }

  return (
    <Link href="/billing" className="block px-3 py-2">
      <div className="flex items-center gap-2 rounded-lg border border-primary/20 bg-primary/5 px-3 py-2 text-xs">
        <Crown className="h-3.5 w-3.5 shrink-0 text-primary" />
        <span className="font-medium truncate">{status.planName} Plan</span>
      </div>
    </Link>
  );
}
```

**Step 2: Add PlanBadge to sidebar**

In `components/layout/sidebar.tsx`, import and render `<PlanBadge />` at the bottom of the sidebar, above the nav items or below the workspace switcher — whichever makes visual sense. Place it after `WorkspaceSwitcher`:

```tsx
import { PlanBadge } from "@/components/billing/plan-badge";

// Inside the sidebar JSX, after WorkspaceSwitcher:
<PlanBadge />
```

**Step 3: Commit**

```bash
git add components/billing/plan-badge.tsx components/layout/sidebar.tsx
git commit -m "feat: add PlanBadge component to sidebar (shows trial/plan status)"
```

---

## Task 10: Create Usage Meter Component

**Files:**
- Create: `components/billing/usage-meter.tsx`

**Step 1: Create the component**

Create `components/billing/usage-meter.tsx`:

```tsx
"use client";

import type { UsageInfo } from "@/lib/api/subscriptions";

function MeterBar({ label, current, max }: { label: string; current: number; max: number }) {
  const isUnlimited = max === -1;
  const percentage = isUnlimited ? 0 : Math.min(100, Math.round((current / max) * 100));
  const isNearLimit = !isUnlimited && percentage >= 80;
  const isAtLimit = !isUnlimited && current >= max;

  return (
    <div className="space-y-1.5">
      <div className="flex items-center justify-between text-sm">
        <span className="text-muted-foreground">{label}</span>
        <span className={`font-medium ${isAtLimit ? "text-red-600 dark:text-red-400" : isNearLimit ? "text-yellow-600 dark:text-yellow-400" : ""}`}>
          {current} / {isUnlimited ? "Unlimited" : max}
        </span>
      </div>
      {!isUnlimited && (
        <div className="h-2 rounded-full bg-muted overflow-hidden">
          <div
            className={`h-full rounded-full transition-all ${isAtLimit ? "bg-red-500" : isNearLimit ? "bg-yellow-500" : "bg-primary"}`}
            style={{ width: `${percentage}%` }}
          />
        </div>
      )}
    </div>
  );
}

export function UsageMeter({ usage }: { usage: UsageInfo }) {
  return (
    <div className="space-y-4">
      <MeterBar label="Team Members" current={usage.currentUsers} max={usage.limits.maxUsers} />
      <MeterBar label="Projects" current={usage.currentProjects} max={usage.limits.maxProjects} />
      <MeterBar label="Workspaces" current={usage.currentWorkspaces} max={usage.limits.maxWorkspaces} />
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add components/billing/usage-meter.tsx
git commit -m "feat: add UsageMeter component with progress bars for plan limits"
```

---

## Task 11: Create Trial Banner Component

**Files:**
- Create: `components/billing/trial-banner.tsx`
- Modify: `components/layout/app-shell.tsx` (add banner above main content)

**Step 1: Create the banner component**

Create `components/billing/trial-banner.tsx`:

```tsx
"use client";

import { useEffect, useState } from "react";
import { useWorkspace } from "@/hooks/use-workspace";
import { getWorkspaceSubscriptionStatus } from "@/lib/api/subscriptions";
import { X } from "lucide-react";
import Link from "next/link";

export function TrialBanner() {
  const { currentWorkspace } = useWorkspace();
  const [daysLeft, setDaysLeft] = useState<number | null>(null);
  const [dismissed, setDismissed] = useState(false);
  const [status, setStatus] = useState<string>("");

  useEffect(() => {
    if (!currentWorkspace?.id) return;
    getWorkspaceSubscriptionStatus(currentWorkspace.id).then((s) => {
      setDaysLeft(s.trialDaysRemaining);
      setStatus(s.status);
    });
  }, [currentWorkspace?.id]);

  // Only show for trialing users with <= 5 days left, or expired
  if (dismissed) return null;
  if (status === "active") return null;
  if (status === "trialing" && daysLeft !== null && daysLeft > 5) return null;
  if (daysLeft === null && status !== "expired") return null;

  const isExpired = status === "expired";
  const isUrgent = !isExpired && daysLeft !== null && daysLeft <= 3;

  return (
    <div className={`relative flex items-center justify-center gap-3 px-4 py-2.5 text-sm font-medium ${isExpired ? "bg-red-600 text-white" : isUrgent ? "bg-red-500 text-white" : "bg-yellow-500 text-yellow-950"}`}>
      <span>
        {isExpired
          ? "Your trial has expired. Upgrade to continue using all features."
          : `Your trial ends in ${daysLeft} day${daysLeft === 1 ? "" : "s"}. Upgrade now to keep your data.`}
      </span>
      <Link
        href="/billing"
        className={`rounded-md px-3 py-1 text-xs font-semibold ${isExpired || isUrgent ? "bg-white text-red-600 hover:bg-white/90" : "bg-yellow-900 text-white hover:bg-yellow-800"}`}
      >
        Upgrade
      </Link>
      {!isExpired && (
        <button
          onClick={() => setDismissed(true)}
          className="absolute right-3 top-1/2 -translate-y-1/2 rounded p-0.5 hover:bg-black/10"
        >
          <X className="h-4 w-4" />
        </button>
      )}
    </div>
  );
}
```

**Step 2: Add TrialBanner to app-shell**

In `components/layout/app-shell.tsx`, import and render `<TrialBanner />` at the top of the main content area, before the `<Topbar>`:

```tsx
import { TrialBanner } from "@/components/billing/trial-banner";

// Inside the JSX, before <Topbar>:
<TrialBanner />
```

**Step 3: Commit**

```bash
git add components/billing/trial-banner.tsx components/layout/app-shell.tsx
git commit -m "feat: add TrialBanner component (shows warning at <=5 days, locks at expiry)"
```

---

## Task 12: Create Billing Page

**Files:**
- Create: `app/billing/page.tsx`
- Modify: `components/layout/sidebar.tsx` (add Billing nav link)

**Step 1: Create the billing page**

Create `app/billing/page.tsx`:

```tsx
"use client";

import { useEffect, useState } from "react";
import { useSession } from "next-auth/react";
import { useWorkspace } from "@/hooks/use-workspace";
import { AppShell } from "@/components/layout/app-shell";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { UsageMeter } from "@/components/billing/usage-meter";
import { getWorkspaceSubscriptionStatus, getUsageInfo, getAllPlans } from "@/lib/api/subscriptions";
import type { UsageInfo } from "@/lib/api/subscriptions";
import type { Plan } from "@/lib/db/schema";
import { Crown, Check } from "lucide-react";

export default function BillingPage() {
  const { data: session } = useSession();
  const userId = (session?.user as any)?.id;
  const { currentWorkspace } = useWorkspace();

  const [plans, setPlans] = useState<Plan[]>([]);
  const [usage, setUsage] = useState<UsageInfo | null>(null);
  const [subStatus, setSubStatus] = useState<{
    isActive: boolean;
    status: string;
    planName: string;
    trialDaysRemaining: number;
    isTrialing: boolean;
  } | null>(null);
  const [currency, setCurrency] = useState<"INR" | "USD">("INR");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!currentWorkspace?.id || !userId) return;
    Promise.all([
      getWorkspaceSubscriptionStatus(currentWorkspace.id),
      getUsageInfo(currentWorkspace.id, userId),
      getAllPlans(),
    ]).then(([status, usageData, planList]) => {
      setSubStatus({ ...status, planName: status.plan?.name ?? "No Plan" });
      setUsage(usageData);
      setPlans(planList);
      setLoading(false);
    });
  }, [currentWorkspace?.id, userId]);

  if (loading) {
    return (
      <AppShell>
        <div className="flex items-center justify-center h-64">
          <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full" />
        </div>
      </AppShell>
    );
  }

  return (
    <AppShell>
      <div className="max-w-5xl mx-auto space-y-8 p-6">
        <div>
          <h1 className="text-2xl font-bold">Billing & Plans</h1>
          <p className="text-muted-foreground">Manage your subscription and usage</p>
        </div>

        {/* Current Plan Status */}
        <Card>
          <CardHeader>
            <CardTitle>Current Plan</CardTitle>
            <CardDescription>
              {subStatus?.isTrialing
                ? `Free trial — ${subStatus.trialDaysRemaining} days remaining`
                : subStatus?.isActive
                  ? "Your subscription is active"
                  : "Your subscription has expired"}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="flex items-center gap-3 mb-6">
              <Crown className="h-8 w-8 text-primary" />
              <div>
                <div className="text-xl font-bold">{subStatus?.planName}</div>
                <Badge variant={subStatus?.isActive ? "default" : "destructive"}>
                  {subStatus?.status === "trialing" ? "Trial" : subStatus?.status}
                </Badge>
              </div>
            </div>
            {usage && <UsageMeter usage={usage} />}
          </CardContent>
        </Card>

        {/* Plan Selection */}
        <div>
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-xl font-semibold">Choose a Plan</h2>
            <div className="flex items-center gap-1 rounded-lg border p-1">
              <button
                onClick={() => setCurrency("INR")}
                className={`rounded-md px-3 py-1 text-sm font-medium transition-colors ${currency === "INR" ? "bg-primary text-primary-foreground" : "text-muted-foreground hover:text-foreground"}`}
              >
                INR
              </button>
              <button
                onClick={() => setCurrency("USD")}
                className={`rounded-md px-3 py-1 text-sm font-medium transition-colors ${currency === "USD" ? "bg-primary text-primary-foreground" : "text-muted-foreground hover:text-foreground"}`}
              >
                USD
              </button>
            </div>
          </div>

          <div className="grid gap-6 md:grid-cols-3">
            {plans.map((plan) => {
              const isCurrent = subStatus?.planName === plan.name;
              const price = currency === "INR" ? plan.price_inr : plan.price_usd;
              const symbol = currency === "INR" ? "₹" : "$";
              const features = (plan.features as string[]) ?? [];

              return (
                <Card key={plan.id} className={`relative ${isCurrent ? "border-primary ring-2 ring-primary/20" : ""}`}>
                  {isCurrent && (
                    <div className="absolute -top-3 left-1/2 -translate-x-1/2">
                      <Badge>Current Plan</Badge>
                    </div>
                  )}
                  <CardHeader>
                    <CardTitle>{plan.name}</CardTitle>
                    <CardDescription>
                      <span className="text-3xl font-bold text-foreground">{symbol}{price}</span>
                      <span className="text-muted-foreground">/month</span>
                    </CardDescription>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-2 text-sm">
                      <div className="flex items-center gap-2">
                        <Check className="h-4 w-4 text-green-500" />
                        <span>{plan.max_users === -1 ? "Unlimited" : plan.max_users} user{plan.max_users !== 1 ? "s" : ""}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Check className="h-4 w-4 text-green-500" />
                        <span>{plan.max_projects === -1 ? "Unlimited" : plan.max_projects} project{plan.max_projects !== 1 ? "s" : ""}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Check className="h-4 w-4 text-green-500" />
                        <span>{plan.max_workspaces === -1 ? "Unlimited" : plan.max_workspaces} workspace{plan.max_workspaces !== 1 ? "s" : ""}</span>
                      </div>
                      {features.map((f) => (
                        <div key={f} className="flex items-center gap-2">
                          <Check className="h-4 w-4 text-green-500" />
                          <span>{f.replace(/_/g, " ")}</span>
                        </div>
                      ))}
                    </div>
                    <Button
                      className="w-full"
                      variant={isCurrent ? "outline" : "default"}
                      disabled={isCurrent}
                    >
                      {isCurrent ? "Current Plan" : "Upgrade"}
                    </Button>
                  </CardContent>
                </Card>
              );
            })}
          </div>
        </div>

        {/* Payment History Placeholder */}
        <Card>
          <CardHeader>
            <CardTitle>Payment History</CardTitle>
            <CardDescription>Your billing history will appear here once you subscribe.</CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">No payments yet.</p>
          </CardContent>
        </Card>
      </div>
    </AppShell>
  );
}
```

**Step 2: Add Billing link to sidebar**

In `components/layout/sidebar.tsx`, add a "Billing" nav item (use `CreditCard` icon from lucide-react) pointing to `/billing`. Place it after Settings or before Settings.

```tsx
import { CreditCard } from "lucide-react";

// In the nav items array:
{ href: "/billing", label: "Billing", icon: CreditCard },
```

**Step 3: Commit**

```bash
git add app/billing/page.tsx components/layout/sidebar.tsx
git commit -m "feat: add billing page with plan cards, usage meter, currency toggle"
```

---

## Task 13: Create Upgrade Wall Component

**Files:**
- Create: `components/billing/upgrade-wall.tsx`

**Step 1: Create the lock screen component**

Create `components/billing/upgrade-wall.tsx`:

```tsx
"use client";

import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Lock } from "lucide-react";
import Link from "next/link";

type UpgradeWallProps = {
  reason: string;
  children: React.ReactNode;
  isBlocked: boolean;
};

export function UpgradeWall({ reason, children, isBlocked }: UpgradeWallProps) {
  if (!isBlocked) return <>{children}</>;

  return (
    <div className="relative">
      <div className="pointer-events-none select-none blur-sm opacity-50">{children}</div>
      <div className="absolute inset-0 flex items-center justify-center">
        <Card className="max-w-md mx-auto text-center">
          <CardContent className="pt-6 space-y-4">
            <div className="mx-auto w-12 h-12 rounded-full bg-muted flex items-center justify-center">
              <Lock className="h-6 w-6 text-muted-foreground" />
            </div>
            <div>
              <h3 className="text-lg font-semibold">Upgrade Required</h3>
              <p className="text-sm text-muted-foreground mt-1">{reason}</p>
            </div>
            <Button asChild>
              <Link href="/billing">View Plans</Link>
            </Button>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

**Step 2: Commit**

```bash
git add components/billing/upgrade-wall.tsx
git commit -m "feat: add UpgradeWall component (blurs content + shows upgrade CTA)"
```

---

## Task 14: Final — Build Verification + Schema Push

**Step 1: Run full build**

```bash
npm run build
```
Expected: Build succeeds with no errors.

**Step 2: Verify all new files exist**

Check that these files exist:
- `lib/db/schema.ts` (modified — 3 new tables)
- `lib/db/seed-plans.ts` (new)
- `lib/api/subscriptions.ts` (new)
- `lib/api/plan-enforcement.ts` (new)
- `components/billing/plan-badge.tsx` (new)
- `components/billing/usage-meter.tsx` (new)
- `components/billing/trial-banner.tsx` (new)
- `components/billing/upgrade-wall.tsx` (new)
- `app/billing/page.tsx` (new)

**Step 3: Run the seed and verify data**

```bash
npm run db:seed
```

**Step 4: Start dev server and test manually**

```bash
npm run dev
```

Test checklist:
- [ ] Dashboard loads without errors
- [ ] Sidebar shows PlanBadge with trial status
- [ ] `/billing` page shows plan cards with INR/USD toggle
- [ ] Usage meter shows correct counts
- [ ] Creating a project beyond limit shows error message
- [ ] Trial banner appears (may need to manipulate trial_end date in DB to test urgency states)

**Step 5: Final commit if any fixes were needed**

```bash
git add .
git commit -m "feat: complete Sprint 1.1 — plan infrastructure, trial system, billing UI"
```

---

## Summary

| Task | Description | New Files | Modified Files |
|------|-------------|-----------|----------------|
| 1 | Plans table | — | `lib/db/schema.ts` |
| 2 | Subscriptions table | — | `lib/db/schema.ts` |
| 3 | Payment history table + DB push | — | `lib/db/schema.ts` |
| 4 | Seed script | `lib/db/seed-plans.ts` | `package.json` |
| 5 | Subscription server actions | `lib/api/subscriptions.ts` | — |
| 6 | Auto-create trial | — | `lib/api/workspaces.ts`, `lib/api/loaders.ts` |
| 7 | Plan enforcement module | `lib/api/plan-enforcement.ts` | — |
| 8 | Wire limits into actions | — | `lib/api/projects.ts`, `lib/api/invitations.ts`, `lib/api/workspaces.ts` |
| 9 | PlanBadge component | `components/billing/plan-badge.tsx` | `components/layout/sidebar.tsx` |
| 10 | UsageMeter component | `components/billing/usage-meter.tsx` | — |
| 11 | TrialBanner component | `components/billing/trial-banner.tsx` | `components/layout/app-shell.tsx` |
| 12 | Billing page | `app/billing/page.tsx` | `components/layout/sidebar.tsx` |
| 13 | UpgradeWall component | `components/billing/upgrade-wall.tsx` | — |
| 14 | Build verification + seed | — | — |
